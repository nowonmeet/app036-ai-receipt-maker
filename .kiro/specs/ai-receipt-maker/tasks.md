# 実装計画

- [ ] 1. プロジェクト構造とコアインターフェースの設定
  - MVVMアーキテクチャに基づくディレクトリ構造を作成
  - 主要なプロトコルとインターフェースを定義してシステム境界を確立
  - _要件: 1.1, 2.1, 3.1_

- [ ] 2. Swift Dataモデルとバリデーションの実装
  - [ ] 2.1 コアデータモデルインターフェースとタイプの作成
    - ReceiptDataとReceiptItemのSwift Dataモデルクラスを実装
    - データ整合性のためのバリデーション関数を実装
    - _要件: 3.1, 3.2, 3.3_

  - [ ] 2.2 UsageTrackerモデルとバリデーションの実装
    - 日次使用量追跡のためのUsageTrackerモデルを実装
    - 使用量制限チェックのバリデーションメソッドを作成
    - _要件: 7.1, 7.4, 8.1_

  - [ ] 2.3 データモデルの関係性と単体テストの実装
    - モデル間の関係性処理をコーディング
    - データモデルバリデーションの単体テストを作成
    - _要件: 3.1, 7.4, 8.5_

- [ ] 3. リポジトリパターンとデータアクセス層の作成
  - [ ] 3.1 ベースリポジトリインターフェースの実装
    - リポジトリの基底プロトコルを作成
    - Swift DataのModelContextを使用したCRUD操作を実装
    - _要件: 3.1, 3.4_

  - [ ] 3.2 ReceiptRepositoryの実装
    - レシートデータのCRUD操作を実装
    - 安全なファイル名生成とデータ取得メソッドを作成
    - リポジトリ操作の単体テストを作成
    - _要件: 3.1, 3.2, 3.4_

  - [ ] 3.3 UsageRepositoryの実装
    - 日次使用量の追跡と管理機能を実装
    - 使用制限チェックとリセット機能を作成
    - 使用量管理の単体テストを作成
    - _要件: 7.1, 7.3, 8.1, 8.3_

- [ ] 4. 外部サービス統合の実装
  - [ ] 4.1 DALL-E APIサービスの実装
    - OpenAI DALL-E APIとの通信クラスを作成
    - プロンプト生成とレスポンス処理を実装
    - APIエラーハンドリングとリトライ機能を追加
    - _要件: 1.1, 1.5_

  - [ ] 4.2 RevenueCatサブスクリプションサービスの実装
    - RevenueCat SDKを統合してサブスクリプション管理を実装
    - サブスクリプション状態チェックとペイウォール表示機能を作成
    - サブスクリプション状態変更の処理を実装
    - _要件: 5.2, 6.1, 6.2, 6.3_

  - [ ] 4.3 画像ストレージサービスの実装
    - アプリのプライベートディレクトリへの安全な画像保存を実装
    - 画像の読み込みと削除機能を作成
    - ストレージエラーハンドリングを追加
    - _要件: 3.1, 3.2, 3.3_

  - [ ] 4.4 透かし処理サービスの実装
    - Core Graphicsを使用した透かし追加機能を実装
    - "AI RECEIPT MAKER"透かしの適用処理を作成
    - 透かし処理の単体テストを作成
    - _要件: 4.1, 4.2_

- [ ] 5. 通貨フォーマットとローカライゼーション機能の実装
  - [ ] 5.1 通貨フォーマッターの実装
    - 地域別通貨フォーマット機能を作成
    - iOS標準のLocaleを使用した自動通貨検出を実装
    - 主要通貨（USD, EUR, JPY等）のサポートを追加
    - _要件: 1.4, 2.3, 9.1, 9.2, 9.3, 9.4, 9.5, 9.6_

  - [ ] 5.2 通貨フォーマッターの単体テスト
    - 各地域の通貨フォーマットテストを作成
    - エッジケースとフォールバック処理のテストを実装
    - _要件: 9.1, 9.6_

- [ ] 6. ViewModelレイヤーの実装
  - [ ] 6.1 MainViewModelの実装
    - メイン画面の状態管理とビジネスロジックを実装
    - 画像生成フローの制御とエラーハンドリングを作成
    - 使用制限チェックとペイウォール表示ロジックを実装
    - _要件: 1.1, 1.5, 7.1, 7.2, 8.1, 8.2_

  - [ ] 6.2 ReceiptFormViewModelの実装
    - レシート入力フォームの状態管理を実装
    - 入力バリデーションとランダムデータ生成を作成
    - フォーム送信処理とエラー表示を実装
    - _要件: 2.1, 2.2, 2.4, 2.5_

  - [ ] 6.3 ViewModelの単体テスト
    - ビジネスロジックとUI状態管理のテストを作成
    - 非同期処理とエラーハンドリングのテストを実装
    - _要件: 1.5, 2.5, 7.2, 8.2_

- [ ] 7. SwiftUI Viewレイヤーの実装
  - [ ] 7.1 メインタブビューの実装
    - アプリのメインナビゲーション構造を作成
    - タブベースのナビゲーションを実装
    - _要件: 10.1, 10.5_

  - [ ] 7.2 レシート生成画面の実装
    - レシート入力フォームのUIを作成
    - 生成ボタンとプログレス表示を実装
    - エラーメッセージ表示機能を追加
    - _要件: 1.1, 2.1, 2.2, 10.1, 10.2_

  - [ ] 7.3 レシートギャラリー画面の実装
    - 保存されたレシートのグリッド表示を作成
    - レシート詳細表示とデバイス保存機能を実装
    - 透かし付き/なし保存の分岐処理を追加
    - _要件: 3.5, 4.3, 5.1, 5.4_

  - [ ] 7.4 設定画面とサブスクリプション管理の実装
    - サブスクリプション状態表示を作成
    - RevenueCatペイウォールビューの統合を実装
    - 使用制限表示とアップグレード促進UIを追加
    - _要件: 6.1, 6.4, 7.2, 8.2, 10.3, 10.4_

- [ ] 8. 画像生成とプロンプト処理の実装
  - [ ] 8.1 レシートプロンプト生成ロジックの実装
    - ユーザー入力からDALL-E用プロンプトを生成する機能を作成
    - ランダムデータ生成とカスタムデータ統合を実装
    - 地域別通貨フォーマットをプロンプトに組み込む処理を追加
    - _要件: 1.2, 1.3, 1.4, 2.2_

  - [ ] 8.2 画像生成フローの統合
    - DALL-E API呼び出しから画像保存までの完全なフローを実装
    - 非同期処理とエラーハンドリングを統合
    - 生成完了後のUI更新処理を追加
    - _要件: 1.1, 1.5, 3.1_

- [ ] 9. 使用制限とサブスクリプション制御の実装
  - [ ] 9.1 日次使用制限チェック機能の実装
    - 無料ユーザー（2回/日）とプレミアムユーザー（10回/日）の制限チェックを実装
    - 日付変更時の使用回数リセット機能を作成
    - 制限到達時のペイウォール表示処理を追加
    - _要件: 7.1, 7.2, 7.3, 8.1, 8.2, 8.3_

  - [ ] 9.2 サブスクリプション状態同期の実装
    - アプリ起動時のRevenueCat状態同期を実装
    - サブスクリプション変更時の即座な制限更新を作成
    - サブスクリプション期限切れ時の処理を追加
    - _要件: 5.3, 6.3, 6.4, 7.5, 8.4_

- [ ] 10. フォトライブラリ統合と透かし処理の実装
  - [ ] 10.1 フォトライブラリ保存機能の実装
    - デバイスのフォトライブラリへの画像保存機能を作成
    - 必要な権限要求とエラーハンドリングを実装
    - 保存成功/失敗のユーザーフィードバックを追加
    - _要件: 4.3, 4.4, 4.5, 5.4_

  - [ ] 10.2 サブスクリプション状態による透かし制御の実装
    - 無料ユーザーには透かし付き、プレミアムユーザーには透かしなしの保存を実装
    - サブスクリプション状態チェックの失敗時フォールバック処理を追加
    - 透かし適用/非適用の分岐ロジックを作成
    - _要件: 4.1, 5.1, 5.5_

- [ ] 11. エラーハンドリングとユーザーフィードバックの実装
  - [ ] 11.1 包括的エラーハンドリングシステムの実装
    - AppErrorエラータイプとローカライズされたエラーメッセージを作成
    - ネットワーク、API、ストレージ、サブスクリプションエラーの処理を実装
    - エラー状態のUI表示とリトライ機能を追加
    - _要件: 1.5, 2.5, 4.4, 5.5_

  - [ ] 11.2 ユーザーフィードバックとローディング状態の実装
    - 画像生成中のプログレス表示を作成
    - 成功/失敗メッセージの表示システムを実装
    - 適切なローディングアニメーションとUI状態管理を追加
    - _要件: 1.1, 4.3, 5.4, 10.5_

- [ ] 12. 統合テストとエンドツーエンドフローの実装
  - [ ] 12.1 主要ユーザーフローの統合テスト
    - レシート生成から保存までの完全なフローテストを作成
    - サブスクリプション購入とプレミアム機能のテストを実装
    - 使用制限とペイウォール表示のテストを追加
    - _要件: 1.1, 4.1, 5.1, 6.1, 7.1, 8.1_

  - [ ] 12.2 エラーケースとエッジケースのテスト
    - ネットワーク障害、API障害、ストレージ障害のテストを作成
    - サブスクリプション状態変更とエラー処理のテストを実装
    - 境界値テスト（使用制限到達等）を追加
    - _要件: 1.5, 5.5, 7.2, 8.2_

- [ ] 13. 最終統合とポリッシュ
  - [ ] 13.1 アプリ全体の統合と最適化
    - すべてのコンポーネントを統合してアプリを完成
    - パフォーマンス最適化とメモリ使用量の改善を実装
    - UI/UXの最終調整とアニメーション追加
    - _要件: 10.1, 10.5_

  - [ ] 13.2 App Store準備とデプロイメント設定
    - プロダクションビルド設定とAPIキー管理を実装
    - App Store審査対応とプライバシー設定を追加
    - 最終的な動作確認とリリース準備を完了
    - _要件: 10.1, 10.2, 10.3, 10.4, 10.5_